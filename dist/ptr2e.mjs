var T=Object.defineProperty;var u=(o,e)=>T(o,"name",{value:e,configurable:!0});var A=Object.defineProperty,l=u((o,e)=>A(o,"name",{value:e,configurable:!0}),"__name");import{T as O,C as H,r as D,p as q}from"./vendor.mjs";function x(o,{whitelist:e,maxTags:t,enforceWhitelist:i=!0,traits:r=!1}){if(o?.hasAttribute("name")&&o.dataset.dtype!=="JSON")throw Error("Usable only on input elements with JSON data-dtype");if(!o)return null;const n=e,a=e?Object.keys(n).length:void 0,s=new O(o,{enforceWhitelist:!!e&&i,keepInvalidTags:!1,skipInvalid:!!e,maxTags:t??a,dropdown:{enabled:0,maxItems:a,searchKeys:["id","value"]},whitelist:n,templates:{tag(d,{settings:h}){return`<tag title="${d.title||d.value}"
                            contenteditable='false'
                            spellcheck='false'
                            tabIndex="${h.a11y.focusableTags?0:-1}"
                            class="${h.classNames.tag} ${d.class||""}"
                            ${this.getAttributes(d)}>
                    <x title='' class="${h.classNames.tagX}" role='button' aria-label='remove tag'></x>
                    <div>
                        <span class="${h.classNames.tagText}">${r?"[":""}${d[h.tagTextProp]||d.value}${r?"]":""}</span>
                    </div>
                </tag>`}}});return o.name&&(s.DOM.scope.dataset.name=o.name),s.DOM.input.blur(),s}u(x,"tagify"),l(x,"tagify"),H.register(...D);class L{static{u(this,"StatsChart")}static{l(this,"StatsChart")}constructor(e,t={},{id:i,cssclass:r}={cssclass:"stats-chart"}){this.sheet=e,this._options=t,this.id=i,this.cssclass=r,this.initialized=!1}get canvas(){return this.sheet.element.find(`canvas.${this.cssclass}${this.id?`#${this.id}`:""}`)}static get defaultOptions(){return{hover:{mode:null},plugins:{legend:{display:!0,position:"bottom",labels:{color:"#fff"}},tooltip:{enabled:!1},datalabels:{formatter:function(e,t){return t.chart.data.labels[t.value]},anchor:"end",clamp:!1,align:"end",offset:0,color:"white"}},elements:{point:{hoverRadius:0,hitRadius:0},line:{borderWidth:0,tension:.05}},scales:{r:{grid:{color:"#ffffff70"},ticks:{display:!1},pointLabels:{color:"#fff"}}}}}get data(){return{labels:["HP","ATK","DEF","SPD","SP.DEF","SP.ATK"],datasets:[{label:"EVs",data:[20,60,25,60,15,55],fill:!0,backgroundColor:"#88c5fe40",datalabels:{display:!1},pointStyle:!1},{label:"Stats",data:[12,30,22,30,6,25],fill:!0,backgroundColor:"#88c5febc",pointStyle:!1}]}}get options(){return foundry.utils.mergeObject(this.constructor.defaultOptions,this._options,{inplace:!1})}render(){return this.initialized?this._rerender():this.canvas.length===0?console.error("No canvas found for stats chart"):(this.chart=new H(this.canvas,{plugins:[q],type:"radar",options:this.options,data:this.data}),this.initialized=!0,this)}_rerender(e=!1){return this.initialized?e?(this.chart.update(),this):(this.chart.destroy(),this.initialized=!1,this.render()):this.render()}}class S extends ActorSheet{static{u(this,"PTRActorSheet")}static{l(this,"PTRActorSheet")}constructor(e,t){super(e,t),this._statsChart=new L(this),this.tab=S.defaultOptions.tabs[0].initial}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{classes:["ptr2e","sheet","actor"],template:"systems/ptr2e/templates/actor/actor-sheet.hbs",width:900,height:660,tabs:[{group:"primary",navSelector:".tabs",contentSelector:".sheet-body",initial:"summary"}],submitOnClose:!0,submitOnChange:!0,scrollY:[".sheet-body"]})}async close(e={}){if(game.ptr.tree.actor===this.actor){this.minimize();return}return super.close(e)}_onChangeTab(e,t,i){return this.tab=i,super._onChangeTab(e,t,i)}getData(){const e=super.getData();return e.traits=this.actor.traits?.map(t=>t.slug),e.party=game.actors.filter(t=>t!=this.actor),e.activeTab=this.tab,e}activateListeners(e){super.activateListeners(e),this._statsChart.render();for(const i of e.find(".ptr-tagify"))x(i,{traits:$(i).hasClass("system-traits")});const t=this.actor;for(const i of e.find(".ptr-trait"))$(i).tooltipster({contentAsHTML:!0,interactive:!0,content:"Loading...",functionInit:function(r,n){const a=t.traits.find(s=>s.slug===i.dataset.trait);(a.description||a.related.length>0)&&renderTemplate("systems/ptr2e/templates/partials/trait-tooltip.hbs",{trait:a}).then(s=>r.content(s))},functionReady:function(r,n){$(n.tooltip).find(".keyword").tooltipster({position:"right",contentAsHTML:!0,content:"This is where the creature-type keyword explanation would go and if you click it it will open the full view instead of the..."})}});e.find(".ptr-perk-tree").on("click",()=>this.actor.togglePerkTree())}}class z extends Combatant{static{u(this,"CombatantPTR2e")}static{l(this,"CombatantPTR2e")}get encounter(){return this.parent}async endTurn(){Hooks.callAll("ptr2e.endTurn",this,this.encounter,game.user.id)}async startTurn(){}}class B extends Combat{static{u(this,"PTRCombat")}static{l(this,"PTRCombat")}_sortCombatants(e,t){const i=l(()=>{const a=e.actor?.system.speed??0;return(t.actor?.system.speed??0)-a},"resolveTie"),r=Number.isNumeric(e.initiative)?e.initiative:-1/0,n=Number.isNumeric(t.initiative)?t.initiative:-1/0;return typeof e.initiative=="number"&&typeof t.initiative=="number"&&e.initiative===t.initiative?i():r-n||(e.id>t.id?1:-1)}async createEmbeddedDocuments(e="Combatant",t,i={}){const r=t.filter(n=>{const a=canvas.tokens.placeables.find(d=>d.id===n.tokenId);if(!a)return!1;const{actor:s}=a;return s?!0:(ui.notifications.warn(`${a.name} has no associated actor.`),!1)});return super.createEmbeddedDocuments(e,r,i)}async rollInitiative(e,t={}){const i=t.extraRollOptions??[];t.secret&&i.push("secret");const n=e.flatMap(s=>this.combatants.get(s)??[]).filter(s=>!!s.actor?.system?.speed),a=await Promise.all(n.map(async s=>{const d={initiative:Math.round(1052.6315789473686/s.actor.system.speed),_id:s.id};return await s.setFlag("ptr2e","baseAV",d.initiative),d}));return t.temporary?a:this.setMultipleInitiatives(a)}async setMultipleInitiatives(e){const t={combatants:e};return this.combatant?.id&&(t.turn=0),this.update(t)}async nextTurn(){const e=this.turn??-1;let t=null,i=!1;for(let[s,d]of this.turns.entries())if(!(s<=e)&&!d.hasActed&&!(this.settings.skipDefeated&&d.isDefeated)){t=s,d.id==="roundsinitiative"&&(i=!0);break}let r=this.round;if(i)return await this.nextRound(),this;const n={round:r,turn:t},a={advanceTime:CONFIG.time.turnTime,direction:1};return Hooks.callAll("combatTurn",this,n,a),await this.update(n,a),this}async nextRound(){if(this.turn===null)return super.nextRound();if(this.turns[(this.turn??0)+1]?.id!=="roundsinitiative")return await super.nextRound(),this;const t=this.combatant,i=this.turns[(this.turn??0)+2];if(!t||!i)return await super.nextRound(),this;const r=i.initiative,n={turn:0,round:this.round+1,combatants:this.combatants.contents.flatMap(s=>s.id==="roundsinitiative"?[{_id:s.id,initiative:s.getFlag("ptr2e","baseAV")-r}]:s.id===t.id&&s.initiative===0?[{_id:s.id,initiative:s.getFlag("ptr2e","baseAV")-r}]:s.id===i.id?[{_id:s.id,initiative:0}]:s.initiative===0?[]:[{_id:s.id,initiative:s.initiative-r}])},a={direction:1};return Hooks.callAll("combatRound",this,n,a),await this.update(n,a),this}async previousTurn(){const e=await this.getFlag("ptr2e","stateBackup");if(e?.length>0){const{combatants:t,round:i,turn:r}=e.pop();if(t.some(n=>n.initiative===0))return await this.update({combatants:t,round:i,turn:r,flags:{ptr2e:{stateBackup:e}}}),this}return this.round===1?(await Dialog.confirm({title:"Restart Combat",content:"Are you sure you want to restart combat?",yes:()=>this.update({round:0,turn:null,combatants:this.combatants.contents.map(t=>({_id:t.id,initiative:null}))})}),this):(ui.notifications.warn("No previous turn to go back to."),this)}async update(e,t={}){this.combatants.get("roundsinitiative")||await Combatant.create({tokenId:void 0,actorId:void 0,_id:"roundsinitiative",name:"The Round",img:"icons/svg/clockwork.svg",hidden:!1,defeated:!1,initiative:100,flags:{ptr2e:{baseAV:100}}},{parent:this,keepId:!0,keepEmbeddedIds:!0});const i=this.combatants.contents.filter(r=>r.initiative===null);if(i.length>0){const r=await this.rollInitiative(i.map(n=>n.id),{secret:!0,temporary:!0});e.combatants=e.combatants??[],e.combatants.push(...r)}if(!e?.flags?.ptr2e?.stateBackup){e.flags=e.flags??{},e.flags.ptr2e=e.flags.ptr2e??{},e.flags.ptr2e.stateBackup=this.flags?.ptr2e?.stateBackup??[];const r={combatants:this.combatants.contents.map(n=>({_id:n._id,initiative:n.initiative})),round:this.round,turn:0};objectsEqual(e.flags.ptr2e.stateBackup.at(-1),r)||e.flags.ptr2e.stateBackup.push(r)}return super.update(e,t)}_onUpdate(e,t,i){if(super._onUpdate(e,t,i),!this.started)return;const{combatant:r,previous:n}=this,[a,s]=[e.round,e.turn],d=typeof a=="number",h=typeof s=="number",g=h&&this.turns[s]?.hasActed===!1,p=d&&(n.round===null||a>n.round),f=h&&(n.turn===null||s>n.turn||g);(d||h)&&Promise.resolve().then(async()=>{if(p||f){const b=this.combatants.get(n.combatantId??"");if(game.user.isGM&&b){const I=b.roundOfLastTurnEnd===n.round;typeof n.round=="number"&&!I&&await b.endTurn({round:n.round})}if(game.user.isGM){const I=r?.roundOfLastTurn===this.round;r&&!I&&((a===1||!p)&&await this.updateInitiatives(b,r),await r.startTurn())}}})}async updateInitiatives(e,t){const i=this.combatants,r=i.get(t.id)?.initiative;return this.setMultipleInitiatives(i.contents.flatMap(n=>n.id===e?.id?[{_id:n.id,initiative:e.getFlag("ptr2e","baseAV")-r}]:n.id===t.id&&n.initiative!==0?[{_id:n.id,initiative:0}]:n.initiative===0?[]:[{_id:n.id,initiative:n.initiative-r}]))}async _manageTurnEvents(e){if(this.previous||game.release.build>=308)return super._manageTurnEvents(e)}}function F(){M(),P()}u(F,"registerHandlebarsHelpers"),l(F,"registerHandlebarsHelpers");function P(){Handlebars.registerHelper("keywords",function(o){return o.map(e=>`<span class="keyword" >&lt;${e}&gt;</span>`).join("")}),Handlebars.registerHelper("calcHeight",function(o){return Math.round((100-o)/100*48)})}u(P,"_registerPTRHelpers"),l(P,"_registerPTRHelpers");function M(){Handlebars.registerHelper("concat",function(){var e="";for(var t in arguments)typeof arguments[t]!="object"&&(e+=arguments[t]);return e}),Handlebars.registerHelper("switch",function(e,t){return this.switch_value=e,t.fn(this)}),Handlebars.registerHelper("case",function(e,t){if(e==this.switch_value)return t.fn(this)}),Handlebars.registerHelper("toLowerCase",function(e){return e.toLowerCase?e.toLowerCase():e}),Handlebars.registerHelper("capitalizeFirst",e=>typeof e!="string"?e:e.charAt(0).toUpperCase()+e.slice(1));const o=l(function(e){var t,i,r,n,a;for(r=e.replace(/([^\W_]+[^\s-]*) */g,function(s){return s.charAt(0).toUpperCase()+s.substr(1).toLowerCase()}),n=["A","An","The","And","But","Or","For","Nor","As","At","By","For","From","In","Into","Near","Of","On","Onto","To","With"],t=0,i=n.length;t<i;t++)r=r.replace(new RegExp("\\s"+n[t]+"\\s","g"),function(s){return s.toLowerCase()});for(a=["Id","Tv"],t=0,i=a.length;t<i;t++)r=r.replace(new RegExp("\\b"+a[t]+"\\b","g"),a[t].toUpperCase());return r},"capitalize");Handlebars.registerHelper("capitalize",o),Handlebars.registerHelper("formatLocalize",(e,t)=>({hash:{[e]:t}})),Handlebars.registerHelper("formatSlug",e=>o(e).replaceAll("-"," ")),Handlebars.registerHelper("isdefined",function(e){return e!==void 0}),Handlebars.registerHelper("is",function(e,t){return e==t}),Handlebars.registerHelper("bigger",function(e,t){return e>t}),Handlebars.registerHelper("biggerOrEqual",function(e,t){return e>=t}),Handlebars.registerHelper("and",function(e,t){return e&&t}),Handlebars.registerHelper("or",function(e,t){return e||t}),Handlebars.registerHelper("not",function(e,t=!1){return e!=t}),Handlebars.registerHelper("divide",(e,t)=>Number(e)/Number(t)),Handlebars.registerHelper("multiply",(e,t)=>Number(e)*Number(t)),Handlebars.registerHelper("floor",e=>Math.floor(Number(e))),Handlebars.registerHelper("minMaxDiceCheck",function(e,t){return e==1?"min":e==t?"max":""}),Handlebars.registerHelper("isGm",function(){return game.user.isGM}),Handlebars.registerHelper("contains",function(e,t){return e=Handlebars.escapeExpression(e),t=Handlebars.escapeExpression(t),t.indexOf(e)>-1}),Handlebars.registerHelper("ifContains",function(e,t,i){return e=Handlebars.escapeExpression(e),t=Handlebars.escapeExpression(t),t.indexOf(e)>-1?i.fn(this):i.inverse(this)}),Handlebars.registerHelper("inc",function(e){return Number(e)+1}),Handlebars.registerHelper("newline",function(e){return e.replace("\\n",`
`)}),Handlebars.registerHelper("lpad",function(e,t,i){for(e=e.toString();e.length<t;)e=i+e;return e}),Handlebars.registerHelper("padDecimal",function(e,t){const i=String(e),r=i.indexOf(".");if(r===-1)return`${i}.${"0".repeat(t)}`;{const n=i.length-r-1;return n<t?`${i}${"0".repeat(t-n)}`:i}}),Handlebars.registerHelper("diceResult",function(e,t){const i=e.terms.find(r=>r.faces==t);if(i)return i.total??i.results[0].result}),Handlebars.registerHelper("split",function(e,t){return e.split(t).map(i=>i.trim())}),Handlebars.registerHelper("isNumber",function(e){return isNaN(Number(e))==!1}),Handlebars.registerHelper("ld",function(e,t){return{hash:{[e]:t}}}),Handlebars.registerHelper("json",function(e){return JSON.stringify(e)})}u(M,"_registerBasicHelpers"),l(M,"_registerBasicHelpers");function _(){const o={"stats-chart":"systems/ptr2e/templates/partials/actor/stats-chart.hbs","actor-movement":"systems/ptr2e/templates/partials/actor/movement.hbs","actor-gear":"systems/ptr2e/templates/partials/actor/gear.hbs","actor-abilities":"systems/ptr2e/templates/partials/actor/abilities.hbs","actor-skills":"systems/ptr2e/templates/partials/actor/skills.hbs","actor-actions":"systems/ptr2e/templates/partials/actor/actions.hbs"};return loadTemplates(Object.values(o)).then(()=>{for(const[e,t]of Object.entries(o))Handlebars.registerPartial(e,`{{> ${t}}}`)})}u(_,"registerTemplates"),l(_,"registerTemplates");class w extends Actor{static{u(this,"PTRActor")}static{l(this,"PTRActor")}get traits(){return this.system.traits}get attributes(){return this.system.attributes}_initialize(){return super._initialize()}prepareData(){return this.health={percent:parseInt(Math.floor(Math.random()*100))},super.prepareData()}prepareBaseData(){return super.prepareBaseData()}prepareEmbeddedDocuments(){return super.prepareEmbeddedDocuments()}prepareDerivedData(){return super.prepareDerivedData()}async togglePerkTree(e){if(game.ptr.tree.actor===this&&e!==!0)return game.ptr.tree.close();if(e!==!1)return game.ptr.tree.open(this)}}const G=new Proxy(w,{construct(o,e){return new w(...e)}});class j extends ItemDirectory{static{u(this,"PerkDirectory")}static{l(this,"PerkDirectory")}get title(){return`${game.i18n.localize("DOCUMENT.Perks")} Directory`}async _onCreateEntry(e,{}={}){e.preventDefault(),e.stopPropagation();const t=e.currentTarget,r={folder:t.closest(".directory-item")?.dataset?.folderId,type:"perk"},n={width:320,left:window.innerWidth-630,top:t.offsetTop};return Item.createDialog(r,n)}_onSearchFilter(e,t,i,r){//!!query;
let n=new Set;const a=new Set,s=new Set;{const d=l((h,g=!0)=>{if(!h||(typeof h=="string"&&(h=this.collection.folders.get(h)),!h))return;const p=h._id;if(a.has(p)){g&&!s.has(p)&&s.add(p);return}a.add(p),g&&s.add(p),h.folder&&d(h.folder)},"includeFolder");this._matchSearchFolders(i,d),this._matchSearchEntries(i,n,a,d)}for(let d of r.querySelectorAll(".directory-item"))if(!d.classList.contains("hidden"))if(d.classList.contains("folder")){let h=a.has(d.dataset.folderId);d.style.display=h?"flex":"none",s.has(d.dataset.folderId)?h&&d.classList.remove("collapsed"):d.classList.toggle("collapsed",!game.folders._expanded[d.dataset.uuid])}else d.style.display=n.has(d.dataset.entryId)?"flex":"none"}_matchSearchEntries(e,t,i,r){super._matchSearchEntries(e,t,i,r);const n=this.collection.index??this.collection.contents;for(const a of n)a.type!=="perk"&&t.delete(a._id)}async close(e={}){if(game.ptr.tree.editMode){this.minimize();return}return super.close(e)}renderPopout(){this.createPopout().render(!0,{top:0,left:window.innerWidth-310})}}class X extends CombatTracker{static{u(this,"PTRCombatTracker")}static{l(this,"PTRCombatTracker")}get template(){return"systems/ptr2e/templates/sidebar/combat-tracker.hbs"}async getData(e){return await super.getData(e)}}const y=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,k=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,W=new RegExp(k,"gu"),U=String.raw`(?:${y})(?=${k})|(?:${k})(?=${y})`,V=String.raw`(?:${y})(?=${y})`,R=String.raw`\p{Lowercase_Letter}`,E=String.raw`\p{Uppercase_Letter}`,J=new RegExp(`(${R})(${E}${V})`,"gu"),Y=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,K=new RegExp(`${E}|(?:${U})${R}`,"gu");function v(o,{camel:e}={camel:null}){if(typeof o!="string")return console.warn("Non-string argument passed to `sluggify`"),"";if(o==="-")return o;if(e===null)return o.replace(J,"$1-$2").toLowerCase().replace(/['’]/g,"").replace(W," ").trim().replace(/[-\s]+/g,"-");if(e==="bactrian"){const t=v(o,{camel:"dromedary"});return t.charAt(0).toUpperCase()+t.slice(1)}if(e==="dromedary")return o.replace(Y,"").replace(/[-_]+/g," ").replace(K,(t,i)=>i===0?t.toLowerCase():t.toUpperCase()).replace(/\s+/g,"");throw new Error(`I'm pretty sure that's not a real camel: ${e}`)}u(v,"sluggify"),l(v,"sluggify");class C extends Item{static{u(this,"PTRItem")}static{l(this,"PTRItem")}get slug(){return this.system.slug||v(this.name)}}class Z extends foundry.abstract.DataModel{static{u(this,"PTRAction")}static{l(this,"PTRAction")}static defineSchema(){const e=foundry.data.fields;return{slug:new e.StringField({required:!0}),name:new e.StringField({required:!0,initial:"New Action"}),description:new e.HTMLField({required:!1,nullable:!0}),traits:new e.ArrayField(new e.StringField),type:new e.StringField({required:!0,choices:()=>["attack","camping","downtime","exploration"]}),range:new e.EmbeddedDataField(Q),cost:new e.SchemaField({activation:new e.StringField({required:!0,choices:()=>["simple","complete","free"]}),powerPoints:new e.NumberField({required:!0,initial:0}),trigger:new e.StringField({required:!1,nullable:!0}),delay:new e.NumberField({required:!1,nullable:!0}),priority:new e.NumberField({required:!1,nullable:!0})})}}}class Q extends foundry.abstract.DataModel{static{u(this,"PTRRange")}static{l(this,"PTRRange")}static defineSchema(){const e=foundry.data.fields;return{target:new e.StringField({required:!0,choices:["self","ally","enemy","creature","object","blast","cone","line","wide-line","emanation","field"]}),distance:new e.NumberField({required:!0,initial:0}),unit:new e.StringField({required:!0,choices:["m","ft"]})}}}class N extends foundry.abstract.TypeDataModel{static{u(this,"ItemSystemBase")}static{l(this,"ItemSystemBase")}static defineSchema(){const e=foundry.data.fields;return{slug:new e.StringField({required:!0}),container:new e.ForeignDocumentField(C,{required:!1,nullable:!0}),actions:new e.ArrayField(new e.EmbeddedDataField(Z)),description:new e.HTMLField({required:!1,nullable:!0}),traits:new e.ArrayField(new e.StringField)}}prepareBaseData(){this.slug??=v(this.name??"")}get name(){return this.parent?.name}}class ee extends N{static{u(this,"PTRGear")}static{l(this,"PTRGear")}static defineSchema(){const e=foundry.data.fields;return Object.assign(super.defineSchema(),{cost:new e.NumberField({required:!0,initial:0,validate:t=>t>=0}),crafting:new e.ObjectField,equipped:new e.EmbeddedDataField(te),grade:new e.StringField({required:!0,initial:"E",choices:["E","E+","D-","D","D+","C-","C","C+","B-","B","B+","A-","A","A+","S-","S","S+"]}),identification:new e.SchemaField({misidentified:new e.ForeignDocumentField(C,{required:!1,nullable:!0}),status:new e.StringField({required:!0,initial:"identified",choices:["identified","unidentified","misidentified"]}),unidentified:new e.SchemaField({name:new e.StringField({required:!0,initial:"Unidentified Item"}),img:new e.FilePathField({required:!0,categories:["IMAGE","MEDIA","VIDEO"],initial:"systems/ptu/css/images/icons/item_icon.png"}),description:new e.HTMLField({required:!0,initial:"<p>Unidentified Item</p>"})})}),quantity:new e.NumberField({required:!0,initial:1,validate:t=>t>=0}),rarity:new e.StringField({required:!0,initial:"common",choices:["common","uncommon","rare","unique"]})})}}class te extends foundry.abstract.DataModel{static{u(this,"EquipmentData")}static{l(this,"EquipmentData")}static defineSchema(){const e=foundry.data.fields;return{carryType:new e.StringField({required:!0,initial:"stowed",choices:["stowed","held","worn","dropped"]}),handsHeld:new e.NumberField({required:!1,nullable:!0,validate:t=>t>=0})}}}const ie={.5:[[0,.5],[.25,0],[.75,0],[1,.5],[.75,1],[.25,1]],1:[[0,.5],[.25,0],[.75,0],[1,.5],[.75,1],[.25,1]],2:[[3/7,.25],[4/7,0],[6/7,0],[1,.25],[6/7,.5],[1,.75],[6/7,1],[4/7,1],[3/7,.75],[1/7,.75],[0,.5],[1/7,.25]],3:[[.4,0],[.6,0],[.7,1/6],[.9,1/6],[1,1/3],[.9,.5],[1,2/3],[.9,5/6],[.7,5/6],[.6,1],[.4,1],[.3,5/6],[.1,5/6],[0,2/3],[.1,.5],[0,1/3],[.1,1/6],[.3,1/6]],4:[[6/13,0],[7/13,1/8],[9/13,1/8],[10/13,.25],[12/13,.25],[1,3/8],[12/13,.5],[1,5/8],[12/13,.75],[10/13,.75],[9/13,7/8],[7/13,7/8],[6/13,1],[4/13,1],[3/13,7/8],[1/13,7/8],[0,.75],[1/13,5/8],[0,.5],[1/13,3/8],[0,.25],[1/13,1/8],[3/13,1/8],[4/13,0]]};class re extends PIXI.Container{static{u(this,"PTRPerkTreeIcon")}static{l(this,"PTRPerkTreeIcon")}constructor(e){super(),this.config=Object.assign({alpha:.8,backgroundColour:0,size:50,tint:16777215},e),this.background=this.addChild(new PIXI.Graphics),this.icon=this.addChild(new PIXI.Sprite),this.icon.anchor.set(.5,.5),this.icon.mask=this.addChild(new PIXI.Graphics),this.border=this.addChild(new PIXI.Graphics),this.number=this.addChild(new PreciseText("",PreciseText.getTextStyle({fontSize:26}))),this.number.anchor.set(.5,.5)}async draw(e={}){const{backgroundColour:t,alpha:i,size:r,borderRadius:n,texture:a,tint:s,text:d}=Object.assign(this.config,e);this.shape=this._getShape(r,n),this.background.clear().beginFill(t,i).drawShape(this.shape).endFill(),this.icon.texture=a,this.icon.width=this.icon.height=r,this.icon.alpha=i??1,this.icon.tint=s??0,this._drawMask(),this._drawBorder(),this.number.text=d??"",this.number.visible=!!d,this.hitArea=new PIXI.Rectangle(r/-2,r/-2,r,r)}_getShape(e=this.config.size,t=this.borderRadius.size){return new PIXI.RoundedRectangle(e/-2,e/-2,e,e,t)}_drawMask(){this.icon.mask.clear().beginFill(16777215).drawShape(this.shape).endFill()}_drawBorder(e=this.config.borderColor,t=this.config.borderWidth){this.border.clear().lineStyle({width:t,color:e,alignment:1}).drawShape(this.shape)}}class ne extends re{static{u(this,"PTRPerkTreeNode")}static{l(this,"PTRPerkTreeNode")}constructor(e,t){super(t),this.node=e,this.position.set(e.point.x,e.point.y)}get active(){return game.ptr.tree.active===this}get editMode(){return game.ptr.tree.editNode===this}async draw(e={}){const t=e.texture??this.node.texture??"";t&&(e.texture=getTexture(t),e.texture??=await loadTexture(t)),this.node.type==="root"&&(e.size=80,e.borderRadius=80),e.alpha=1,e.borderColor=this.node.color,e.borderWidth=3,await super.draw(e),this._activateInteraction()}_getShape(){const e=this.config.size,t=e/2;if(this.node.type==="root"){const i=e,r=e*Math.sqrt(3)/2,n=ie[1].reduce((a,[s,d])=>(a.push(s*i-i/2),a.push(d*r-r/2),a),[]);return new PIXI.Polygon(n)}return new PIXI.Circle(0,0,t)}_activateInteraction(){this.removeAllListeners(),this.on("pointerover",this.#i.bind(this)),this.on("pointerout",this.#r.bind(this)),this.on("pointerdown",this.#e.bind(this)),this.on("pointerup",this.#a.bind(this)),this.on("globalpointermove",this.#o.bind(this)),this.eventMode="static",this.cursor="pointer"}async _updatePosition({x:e,y:t,visible:i}=this.position){if(this.originalPosition?.equals({x:e,y:t}))return;const r=Math.toDegrees(Math.atan2(t,e)),n=Math.sqrt(e**2+t**2),a=Ray.fromAngle(0,0,Math.toRadians(r),n);this.node.point=a.B;const s={angle:r,distance:n};i!==void 0&&(s.visible=i),await this.node.perk.update({"system.node":s}),game.ptr.tree.refresh({nodeRefresh:!0})}#e(e){if(e.stopPropagation(),e.data.button===2)return this.#t(e);if(e.data.button===0)return this.#s(e)}#t(e){if(game.ptr.tree.editMode){if(game.ptr.tree.editNode&&game.ptr.tree.editNode!==this)return this.#n(e);game.ptr.tree.toggleEditNode(this),this.editMode?(this.scale.set(1.2,1.2),this._drawBorder(65280)):(this.scale.set(1,1),this._drawBorder())}}async#n(e){const t=game.ptr.tree.editNode;if(!(!t||t===this)){switch(e.data.button){case 0:{if(this.node.connected.has(t.node)||this.node.type==="root"&&t.node.type==="root")return;const i=l((r,n)=>{const a=new Set(r.node.perk._source.system.node.connected);return a.add(n.node.id),r.node.perk.update({"system.node.connected":[...a]})},"connectNodes");this.node.type==="root"?await i(t,this):await i(this,t);break}case 2:{if(!this.node.connected.has(t.node))return;this.node.connected.delete(t.node),t.node.connected.delete(this.node);const i=new Set(this.node.perk._source.system.node.connected);if(!i.has(t.node.id)){const r=new Set(t.node.perk._source.system.node.connected);if(!r.has(this.node.id))return;r.delete(this.node.id),await t.node.perk.update({"system.node.connected":[...r]});break}i.delete(t.node.id),await this.node.perk.update({"system.node.connected":[...i]});break}}await game.ptr.tree.refresh({nodeRefresh:!0})}}#s(e){if(game.ptr.tree.editNode)return this.#n(e);this.originalPosition=this.position.clone(),this.active?(game.ptr.tree.deactivateNode(),this.#r(e)):(this.#i(e),game.ptr.tree.activateNode(this))}#a(e){game.ptr.tree.editNode||(e.stopPropagation(),this.#r(e),this.active&&(game.ptr.tree.deactivateNode(),this.mouseIgnored=!0,this._updatePosition()))}#i(e){this.editMode||game.ptr.tree.app.renderer.enabled&&document.elementFromPoint(e.globalX,e.globalY)?.id==="perk-tree"&&(this.mouseIgnored||this.scale.set(1.2,1.2))}#r(e){this.editMode||game.ptr.tree.app.renderer.enabled&&document.elementFromPoint(e.globalX,e.globalY)?.id==="perk-tree"&&(this.active||(this.scale.set(1,1),this.mouseIgnored=!1))}#o(e){if(!game.ptr.tree.app.renderer.enabled||document.elementFromPoint(e.globalX,e.globalY)?.id!=="perk-tree"||!this.active)return;const t=e.data.getLocalPosition(this.parent);this.position.set(t.x,t.y)}}class c{static{u(this,"PTRPerkTreeNodeData")}static{l(this,"PTRPerkTreeNodeData")}constructor({id:e,texture:t,type:i="node",angle:r=0,distance:n=200,connected:a=[],visible:s=!0}={},d){if(c.#e.has(e))return console.warn(`PTRPerkTreeNode: node with id ${e} already exists: ignoring`);const h=Ray.fromAngle(0,0,Math.toRadians(r),n);Object.defineProperties(this,{id:{value:e,writable:!1,enumerable:!0},point:{value:h.B,writable:!0,enumerable:!0},texture:{value:t,writable:!0,enumerable:!0},type:{value:i,writable:!1,enumerable:!0},visible:{value:s,writable:!0,enumerable:!0},perk:{value:d,writable:!1,enumerable:!1}});for(const p of a){const f=c.#e.get(p);if(!f)return this.retryInfo={id:e,type:i,texture:t,angle:r,distance:n,connected:a},this.addFailedConnection();f.connect(this)}c.#e.set(e,this);const g=c.#t.get(e);if(!(!g||!g.linked)){for(const p of g.linked){const f=c.#t.get(p);if(!f){console.warn(`PTRPerkTreeNodeData: failed node ${p} does not exist`);continue}f.required.delete(e),f.required.size||(new c(f.retryInfo),c.#e.has(f.retryInfo.id)&&c.#t.delete(f.retryInfo.id))}g.failed||c.#t.delete(e)}}static#e=new Map;static#t=new Map;static get nodes(){return c.#e}static get origin(){return this.#e.get("node0")??this.origins.at(0)}static get origins(){return[...this.#e.values()].filter(e=>e.type=="root")}connected=new Set;connect(e){this.connected.add(e),e.connected.add(this)}addFailedConnection(){for(const e of this.retryInfo.connected){if(c.#e.get(e))continue;const i=c.#t.get(e);if(!i){c.#t.set(e,{failed:!1,linked:new Set([this.retryInfo.id])});continue}if(!i.linked){for(const r of i.required)c.#e.get(r)&&(i.required.delete(r),i.required.size||(new c(i.retryInfo),c.#e.has(i.retryInfo.id)&&c.#t.delete(i.retryInfo.id)));if(c.#t.has(i.retryInfo.id)){i.linked=new Set([this.retryInfo.id]);continue}}i.linked.add(this.retryInfo.id)}c.#t.set(this.retryInfo.id,{failed:!0,required:new Set(this.retryInfo.connected),retryInfo:this.retryInfo})}static fromPerk(e){const t=e._source?.node;if(!t)return t;if(c.#e.has(t.id)){if(c.#e.get(t.id)?.perk?.id===e.parent.id){const i=c.#e.get(t.id).connected?.map(n=>n.id)??[];for(const n of i){const a=c.#e.get(n);a&&a.connected.delete(c.#e.get(t.id))}c.#e.delete(t.id);const r=foundry.utils.duplicate(t);return r.connected=[...new Set([...i,...t.connected])],new c(r,e.parent)}return c.#e.get(t.id)}return new c(t,e.parent)}}globalThis.PTRPerkTreeNodeData=c;class se extends N{static{u(this,"PTRPerk")}static{l(this,"PTRPerk")}static defineSchema(){const e=foundry.data.fields;return Object.assign(super.defineSchema(),{node:new e.SchemaField({id:new e.StringField({required:!0,blank:!1,initial:()=>foundry.utils.randomID()}),angle:new e.AngleField({required:!0,initial:0}),distance:new e.NumberField({required:!0,initial:100,validate:t=>t>=0}),type:new e.StringField({choices:["normal","root","ranked"],required:!0,initial:"normal"}),connected:new e.ArrayField(new e.StringField),texture:new e.FilePathField({required:!0,categories:["IMAGE","MEDIA","VIDEO"],initial:"systems/ptu/css/images/types2/UntypedIC_Icon.png"}),visible:new e.BooleanField({required:!0,initial:!0})}),cost:new e.NumberField,prerequisites:new e.ArrayField(new e.StringField)})}prepareBaseData(){super.prepareBaseData(),this.node=c.fromPerk(this)}async toEmbed(){const e=document.createElement("div");return e.innerHTML=`<h2>Perk: ${this.name}</h2><p>Effect: ${this.description}</p>`,e}}class ae extends ItemSheet{static{u(this,"PTRPerkSheet")}static{l(this,"PTRPerkSheet")}}const m={Actor:{documentClass:w,proxy:G,documentClasses:{},sheetClasses:{}},Item:{documentClass:C,dataModels:{perk:se,gear:ee},sheetClasses:{perk:ae}},ui:{perks:j,combat:X}};class oe extends Application{static{u(this,"PTRPerkTreeHUD")}static{l(this,"PTRPerkTreeHUD")}static get defaultOptions(){return foundry.utils.mergeObject(super.defaultOptions,{id:"perk-tree-hud",template:"systems/ptr2e/templates/perk-tree/hud.hbs",popOut:!1})}get tree(){return game.ptr.tree}getData(e={}){return{actor:this.tree.actor,editMode:this.tree.editMode}}activateListeners(e){e.find("button.close").click(()=>this.tree.close()),e.find("button.refresh").click(()=>this.tree.refresh({nodeRefresh:!0})),e.find("button.toggleEdit").click(()=>this.tree.toggleEditMode())}}class de extends PIXI.Container{static{u(this,"PTRPerkTree")}static{l(this,"PTRPerkTree")}constructor(){super(),this._initialize()}#e=!1;#t=null;_initialize(){Object.defineProperty(this,"canvas",{value:document.createElement("canvas"),writable:!1}),this.canvas.id="perk-tree",this.canvas.hidden=!0,document.body.appendChild(this.canvas),this.#t=new DragDrop({callbacks:{drop:this._onDrop.bind(this)}}).bind(this.canvas),Object.defineProperty(this,"app",{value:new PIXI.Application({view:this.canvas,width:window.innerWidth,height:window.innerHeight,transparent:!0,resolution:1,antialias:!0,background:13421772,backgroundAlpha:.35,powerPreference:"high-performance"}),writable:!1}),Object.defineProperty(this,"stage",{value:this.app.stage,writable:!1}),Object.defineProperty(this,"controls",{value:new oe,writable:!1}),this.stage.addChild(this),this.editMode=!1}async open(e,{resetView:t}={}){if(!(e instanceof w))throw new Error("PTRPerkTree.open: actor must be an instance of PTRActor");await this.draw(),this.actor=e,await e.sheet._render(!1,{left:20,top:20}),e.sheet.minimize(),this.pan(t?{x:0,y:0,scale:1}:{}),this.refresh(),this.app.renderer.enabled=!0,this.canvas.hidden=!1,this.editMode&&ui.perks._popout&&ui.perks.renderPopout()}async close(){const e=this.actor;this.actor=null,await e?.sheet.render(!1),e.sheet.maximize(),this.controls.close(),this.app.renderer.enabled=!1,this.canvas.hidden=!0,this.editMode&&ui.perks._popout?.close()}async draw(){if(this.#e)return;this.backgroundLayer=this.addChild(new PIXI.Container),this.foregroundLayer=this.addChild(new PIXI.Container),this.background=this.backgroundLayer.addChild(await this._drawBackground()),this.edges=this.backgroundLayer.addChild(new PIXI.Graphics),this.edges.lineStyle({width:5,color:16777215,alpha:.4}),this.connections=this.backgroundLayer.addChild(new PIXI.Graphics),this.nodes=this.backgroundLayer.addChild(new PIXI.Container);const e=new Set;for(const t of c.origins)e.has(t.id)||(await this._drawNode(t),e.add(t.id)),await this._drawNodes(t.connected,e);this.#n(),canvas.hud.render(!0),this.refresh(),this.#e=!0}async _drawBackground(){const t=new PIXI.Graphics;return t.beginFill(0,.1).drawRect(-1e4,-1e4,2e4,2e4).endFill(),t}_drawConnections(e,t){for(const i of e.connected)t.has(i.id)||i.visible&&this.connections.lineStyle({color:i.color,width:5,alpha:1}).moveTo(e.point.x,e.point.y).lineTo(i.point.x,i.point.y)}async _drawNodes(e,t=new Set){const i=[];for(const r of e)t.has(r.id)||r.visible&&(await this._drawNode(r),t.add(r.id),i.push(...r.connected));i.length&&await this._drawNodes(i,t)}async _drawNode(e){const t=e.icon=new ne(e,{borderColor:e.color});this.nodes.addChild(t)}async refresh({nodeRefresh:e=!1}={}){if(!this.actor)return;if(e){this.editNode=null,this.nodes.removeChildren();const i=new Set;for(const r of c.origins){if(!i.has(r.id)){if(!r.visible)continue;await this._drawNode(r),i.add(r.id)}await this._drawNodes(r.connected,i)}if(this.editMode)for(const r of c.nodes.values())r.visible&&(r.connected.length||r.icon?.visible||await this._drawNode(r));return this.refresh()}this.connections.clear(),this.edges.clear();const t=new Set;for(const i of c.nodes.values())i.visible&&(i.icon?.draw({text:[...i.id].at(-1)}),this._drawConnections(i,t),t.add(i.id));this.controls.render(!0)}pan({x:e,y:t,scale:i}={}){e??=this.stage.pivot.x,t??=this.stage.pivot.y,i??=this.stage.scale.x,this.stage.pivot.set(e,t),this.stage.scale.set(i,i)}activateNode(e){this.active&&this.deactivateNode(),this.active=e}deactivateNode(){this.active&&(this.active.scale.set(1,1),this.active=null)}toggleEditNode(e){this.editNode===e?this.editNode=null:this.editNode=e}toggleEditMode(){this.editMode=!this.editMode,this.editMode?((!ui.perks._popout||ui.perks._popout_minimized)&&ui.perks.renderPopout(),this.app.renderer.backgroundColor=8722970,this.app.renderer.backgroundAlpha=.35):(ui.perks._popout?.close(),this.app.renderer.backgroundColor=13421772,this.app.renderer.backgroundAlpha=.35),this.refresh()}async _onDrop(e){e.preventDefault();const t=TextEditor.getDragEventData(e);if(!t.type)return;const[i,r]=[e.clientX,e.clientY],n=this.stage.worldTransform;if(t.x=(i-n.tx)/this.stage.scale.x,t.y=(r-n.ty)/this.stage.scale.y,Hooks.call("dropPerkWebCanvasData",this,t)!==!1)switch(t.type){case"Item":{const s=await Item.fromDropData(t);if(!s||s.type!=="perk")return;if(s.system.node?.icon?.visible)return await s.system.node.icon._updatePosition({x:t.x,y:t.y});if(s.system.node?.icon?.visible===!1)return await s.system.node.icon._updatePosition({x:t.x,y:t.y,visible:!0});{if(!t.uuid)return console.warn("PTR | No UUID found on dropped item, therefore unable to edit node.");const d=Math.toDegrees(Math.atan2(t.y,t.x)),h=Math.sqrt(t.x**2+t.y**2);await s.update({"system.node":{angle:d,distance:h,visible:!0}}),this.refresh({nodeRefresh:!0})}}}}#n(){this.backgroundLayer.eventMode="passive",this.backgroundLayer.children.forEach(e=>e.eventMode="none"),this.nodes.eventMode="passive",this.background.eventMode="static",this.interactionManager=new MouseInteractionManager(this,this,{},{clickLeft:this.#s,dragRightStart:null,dragRightMove:this.#a,dragRightDrop:null,dragRightCancel:null},{application:this.app,dragResistance:30}).activate(),window.addEventListener("resize",this.#i.bind(this)),window.addEventListener("wheel",this.#r.bind(this),{passive:!1}),this.#i()}#s(e){e.stopPropagation(),this.deactivateNode()}#a(e){const{origin:i,destination:r}=e.interactionData,n=r.x-i.x,a=r.y-i.y;this.pan({x:this.stage.pivot.x-n*.8,y:this.stage.pivot.y-a*.8})}#i(){this.app.renderer.resize(window.innerWidth,window.innerHeight);const{width:e,height:t}=this.app.renderer.screen;this.stage.position.set(e/2,t/2),this.pan(this.stage.pivot)}#r(e){if(this.canvas.hidden||e.target?.id!=="perk-tree")return;const t=e.delta<0?1.05:.95;this.pan({scale:t*this.stage.scale.x})}}const ce={onInit(){const o={tree:new de};game.ptr=foundry.utils.mergeObject(game.ptr??{},o)},onSetup(){},onReady(){}},le={listen(){Hooks.once("init",()=>{console.log("PTR 2e | Initializing"),window.actor=function(){return canvas.tokens.controlled[0]?.actor},CONFIG.PTR=m,Object.freeze(CONFIG.PTR),CONFIG.Combat.documentClass=B,CONFIG.Combatant.documentClass=z,CONFIG.ui.combat=m.ui.combat,CONFIG.ui.perks=m.ui.perks,CONFIG.Actor.documentClass=m.Actor.proxy,CONFIG.Item.documentClass=m.Item.documentClass,CONFIG.Item.dataModels=m.Item.dataModels,Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet("ptr2e",S,{makeDefault:!0}),F(),_(),ce.onInit()}),Hooks.once("setup",()=>{})}},ue={listen(){const o=[le];for(const e of o)e.listen()}};ue.listen();
